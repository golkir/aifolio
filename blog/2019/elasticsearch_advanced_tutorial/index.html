<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content="google-site-verification=mxT-kXkFbbMzev31Xd0qz1VEPrAz0tiw3tTEBZYFB9Q"> <meta name="msvalidate.01" content=""> <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Using Advanced Elasticsearch Methods With Node.js Elasticsearch Client | Kirill A. Goltsman </title> <meta name="author" content="Kirill A. Goltsman"> <meta name="description" content="Kirill Goltsman - software engineer and tech writer, AI/ML, statistics, blockchain. "> <meta name="keywords" content="Artificial Intelligence, Machine Learning, data science"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://golkir.github.io/blog/2019/elasticsearch_advanced_tutorial/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.min.js" integrity="sha256-rjmgmaB99riUNcdlrDtcAiwtLIojSxNyUFdl+Qh+rB4=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> <style type="text/css">.fake-img{background:#bbb;border:1px solid rgba(0,0,0,0.1);box-shadow:0 0 4px rgba(0,0,0,0.1);margin-bottom:12px}.fake-img p{font-family:monospace;color:white;text-align:left;margin:12px 0;text-align:center;font-size:16px}</style> </head> <body> <d-front-matter> <script async type="text/json">
      {
            "title": "Using Advanced Elasticsearch Methods With Node.js Elasticsearch Client",
            "description": "",
            "published": "December 12, 2019",
            "authors": [
              
              {
                "author": "Kirill Goltsman",
                "authorURL": "https://en.wikipedia.org/wiki/Albert_Einstein",
                "affiliations": [
                  {
                    "name": "IAS, Princeton",
                    "url": ""
                  }
                ]
              }
              
            ],
            "katex": {
              "delimiters": [
                {
                  "left": "$",
                  "right": "$",
                  "display": false
                },
                {
                  "left": "$$",
                  "right": "$$",
                  "display": true
                }
              ]
            }
          }
    </script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Kirill</span> A. Goltsman </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>Using Advanced Elasticsearch Methods With Node.js Elasticsearch Client</h1> <p></p> </d-title> <d-byline></d-byline> <d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div> <a href="#scrolling">Scrolling</a> </div> <div> <a href="#aggregations">Aggregations</a> </div> <div> <a href="#language-analyzers">Language Analyzers</a> </div> </nav> </d-contents> <p>In the previous <a href="https://qbox.io/blog/integrating-elasticsearch-into-node-js-application" rel="external nofollow noopener" target="_blank">tutorial</a>, we have discussed how to use elasticsearch.js, the official Node.js client for Elasticsearch, to index, add documents, and search them using simple queries and Query DSL. In this tutorial, we’re going to dive deeper into elasticsearch.js describing more advanced methods and concepts like scrolling, aggregations, and analyzers.</p> <p>As always, we will be using hosted Elasticsearch on Qbox.io. We assume that you have installed the latest version of Node.js, downloaded the elasticsearch.js module into your Node.js application and connected it to your Elasticsearch cluster as described in the previous tutorial.</p> <h3 id="scrolling-">**Scrolling **</h3> <p>Search requests discussed in the <a href="https://qbox.io/blog/integrating-elasticsearch-into-node-js-application" rel="external nofollow noopener" target="_blank">previous tutorial</a> are convenient if you want to retrieve a single ‘<em>page</em>’ of results. However, what if you need to return a large number of results from a single request? Then, you would probably need a cursor implemented in the Elasticsearch as a Scroll API. Keep in mind that scrolling is not intended for the real-time user requests (normally, you would paginate the content for users), but rather for batch processing of a large amount of data or re-indexing your content.</p> <p>Below is an example of how we can use scrolling to retrieve all blog posts featuring ‘Node’ in their title and save them to the <strong>allTitles</strong> array for later processing.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">allTitles</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nx">client</span><span class="p">.</span><span class="nf">search</span><span class="p">({</span>
            <span class="na">index</span><span class="p">:</span> <span class="dl">'</span><span class="s1">posts</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">scroll</span><span class="p">:</span> <span class="dl">'</span><span class="s1">10s</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// keep the search results "scrollable" for 10 seconds</span>
            <span class="na">source</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">title</span><span class="dl">'</span><span class="p">],</span> <span class="c1">// filter the source to only include the title field</span>
            <span class="na">q</span><span class="p">:</span> <span class="dl">'</span><span class="s1">title:Node</span><span class="dl">'</span>
        <span class="p">},</span> <span class="kd">function</span> <span class="nf">getMoreUntilDone</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// collect the title from each response</span>
            <span class="nx">response</span><span class="p">.</span><span class="nx">hits</span><span class="p">.</span><span class="nx">hits</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">hit</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">allTitles</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">hit</span><span class="p">.</span><span class="nx">_source</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span>
            <span class="p">});</span>
</code></pre></div></div> <p>Here, we are using a scroll parameter with a value <strong>‘10s’</strong>, which tells Elasticsearch how long it should keep the “search context”. This value should not be big enough because it is used only to process the previous batch of results, not the entire set of results. Also, the callback function <strong>getMoreUntilDone</strong> returns a response object with <strong>_scroll_id</strong> which indicates the id of a current scroll. This id should then be passed to the Scroll API in order to retrieve the next batch of results. The <strong>_scroll_id</strong> looks like this:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">POST</span> <span class="o">/</span><span class="nx">_search</span><span class="o">/</span><span class="nx">scroll</span> 
<span class="p">{</span>
    <span class="dl">"</span><span class="s2">scroll</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">10s</span><span class="dl">"</span><span class="p">,</span> 
    <span class="dl">"</span><span class="s2">scroll_id</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAD4WYm9laVYtZndUQlNsdDcwakFMNjU1QQ==</span><span class="dl">"</span> 
<span class="p">}</span>
</code></pre></div></div> <p>After we get <strong>_scroll_id</strong>, we can continue with retrieving our posts.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if </span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">hits</span><span class="p">.</span><span class="nx">total</span> <span class="o">&gt;</span> <span class="nx">allTitles</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//ask elasticsearch for the next set of hits from this search</span>
    <span class="nx">client</span><span class="p">.</span><span class="nf">scroll</span><span class="p">({</span>
        <span class="na">scrollId</span><span class="p">:</span> <span class="nx">response</span><span class="p">.</span><span class="nx">_scroll_id</span><span class="p">,</span>
        <span class="na">scroll</span><span class="p">:</span> <span class="dl">'</span><span class="s1">10s</span><span class="dl">'</span>
    <span class="p">},</span> <span class="nx">getMoreUntilDone</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">every Node title</span><span class="dl">'</span><span class="p">,</span> <span class="nx">allTitles</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div> <p>What this code actually does is specifying a scroll id for the next batch of pasts (and because <strong>_scroll_id</strong> changes with each request, we need to specify the newest one) and recursively calling <strong>getMoreUntilDone</strong> function as long as the total number of hits in our response is greater than the length of the **allTitles ** array.</p> <h3 id="aggregations">Aggregations</h3> <p>Aggregations are useful whenever you want to build analytic and quantitative information over a set of documents. Elasticsearch.js supports key types of Elasticsearch aggregations including metrics aggregations for computing numerical parameters of your documents (e.g average value, max/min value or percentile ranks over a set of documents), bucketing aggregations for defining sets of documents associated with certain criterion, matrix aggregations operating on multiple fields and producing matrix result based on values extracted from those, and pipeline aggregations that aggregate the output of other aggregations and their associated metrics.</p> <p>To understand how aggregations work in elasticsearch.js, let’s address the case of metrics aggregations. Assuming we have an index named <strong>‘grades’</strong> where we store student grades in specific subjects (e.g math), our task is to calculate the average grade and max/min grades earned by students in our collection. To accomplish this, we first need to define the aggregation parameters in our search query.</p> <p>A typical structure of aggregations definition looks like this:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="dl">"</span><span class="s2">aggregations</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">&lt;aggregation_name&gt;</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">&lt;aggregation_type&gt;</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
            <span class="o">&lt;</span><span class="nx">aggregation_body</span><span class="o">&gt;</span>
        <span class="p">}</span>
        <span class="p">[,</span><span class="dl">"</span><span class="s2">meta</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>  <span class="p">[</span><span class="o">&lt;</span><span class="nx">meta_data_body</span><span class="o">&gt;</span><span class="p">]</span> <span class="p">}</span> <span class="p">]?</span>
        <span class="p">[,</span><span class="dl">"</span><span class="s2">aggregations</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="o">&lt;</span><span class="nx">sub_aggregation</span><span class="o">&gt;</span><span class="p">]</span><span class="o">+</span> <span class="p">}</span> <span class="p">]?</span>
    <span class="p">}</span>
    <span class="p">[,</span><span class="dl">"</span><span class="s2">&lt;aggregation_name_2&gt;</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span> <span class="p">]</span><span class="o">*</span>
<span class="p">}</span>
</code></pre></div></div> <p>Using elasticsearch.js, we can define aggregations as the object within search request body:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">client</span><span class="p">.</span><span class="nf">search</span><span class="p">({</span>
    <span class="na">index</span><span class="p">:</span> <span class="dl">'</span><span class="s1">grades</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">body</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">aggs</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">avg_grade</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
                <span class="dl">"</span><span class="s2">avg</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="dl">"</span><span class="s2">field</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">grade</span><span class="dl">"</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}).</span><span class="nf">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">trace</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div> <p>In this code, <strong>avg_grade</strong> is a variable we define to store the result of our average grade computation and a ‘field’ property specifies the field that should be aggregated. In our case, this is a ‘grade’ field that stores student grades.</p> <p>If the request is successful, we get a response that looks like this:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">aggregations</span><span class="p">:{</span> <span class="nl">avg_grade</span><span class="p">:</span> <span class="p">{</span> <span class="na">value</span><span class="p">:</span> <span class="mf">70.33333333333333</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></div></div> <p>We can include as many aggregation types in our <strong>aggs</strong> object as we want. For example, in the code snippet below we simultaneously calculate the average, min and max values of our grades.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">client</span><span class="p">.</span><span class="nx">search</span><span class="p">({</span>
            <span class="na">index</span><span class="p">:</span> <span class="dl">'</span><span class="s1">grades</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">body</span><span class="p">:</span> <span class="p">{</span>
                <span class="dl">"</span><span class="s2">aggs</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="dl">"</span><span class="s2">avg_grade</span><span class="dl">"</span><span class="p">:</span>
                    <span class="p">{</span>
                        <span class="dl">"</span><span class="s2">avg</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
                            <span class="dl">"</span><span class="s2">field</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">grade</span><span class="dl">"</span>
                        <span class="p">}</span>
                    <span class="p">},</span>
                    <span class="dl">"</span><span class="s2">min_grade</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="dl">"</span><span class="s2">min</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
                            <span class="dl">"</span><span class="s2">field</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">grade</span><span class="dl">"</span>
                        <span class="p">}</span>
                    <span class="p">},</span>
                    <span class="dl">"</span><span class="s2">max_grade</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="dl">"</span><span class="s2">max</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
                            <span class="dl">"</span><span class="s2">field</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">grade</span><span class="dl">"</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
</code></pre></div></div> <p>If the response is successful, we get the following results:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="p">{</span> <span class="nl">max_grade</span><span class="p">:</span> <span class="p">{</span> <span class="na">value</span><span class="p">:</span> <span class="mi">94</span> <span class="p">},</span>
    <span class="nx">min_grade</span><span class="p">:{</span> <span class="nl">value</span><span class="p">:</span> <span class="mi">43</span> <span class="p">},</span>
    <span class="nx">avg_grade</span><span class="p">:{</span> <span class="nl">value</span><span class="p">:</span> <span class="mf">70.33333333333333</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></div></div> <p>We can also use cardinality aggregation to calculate a number of unique entities in our collection. For example, if you are indexing musical albums you can count unique bands that match the user query.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
    <span class="dl">"</span><span class="s2">aggs</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">band_count</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">cardinality</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
                <span class="dl">"</span><span class="s2">field</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">band</span><span class="dl">"</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>The successful response below means that there are 3 unique bands in our albums collection.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
    <span class="dl">"</span><span class="s2">aggregations</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">type_count</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">value</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">3</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>In addition, Metrics aggregations support Geo points and their centroid calculation, percentiles, the sum of numeric values extracted from aggregated documents and other useful methods.</p> <h3 id="language-analyzers">Language Analyzers</h3> <p>Language analyzers convert text, like a musical album’s title into tokens or terms which are added to the inverted index for searching. This index will include not only exact words but plural word forms, infinitive verbs etc. This conversion makes it easy to match user queries (which might not be exactly correct) with documents in your collection.</p> <p>For example, the in-built <em>english</em> analyzer will transform</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>“the QUICK brown foxes jumped over the lazy dog!”
</code></pre></div></div> <p>into the following inverted index:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[quick, brown, fox, jump, over, lazy, dog]
</code></pre></div></div> <p>To set a language analyzer to <em>english</em> we should specify a mapping for a searchable property of our document. Let’s assume that we have created an index named “albums” to store musical albums. Then, we can insert a new mapping with <em>english</em> analyzer for a property “title” of our document “album”. This makes our album titles searchable according to the <em>english</em> analyzer rules mentioned above.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">client</span><span class="p">.</span><span class="nx">indices</span><span class="p">.</span><span class="nf">putMapping</span><span class="p">({</span>
    <span class="na">index</span><span class="p">:</span> <span class="dl">'</span><span class="s1">albums</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">album</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">body</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
            <span class="dl">'</span><span class="s1">title</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="dl">'</span><span class="s1">type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">string</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// type is a required attribute if index is specified</span>
                <span class="dl">'</span><span class="s1">analyzer</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">english</span><span class="dl">'</span>
            <span class="p">},</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">status</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div> <p>Now, if we have a Pink Floyd’s 1973 album “The Dark Side of the Moon” in our album list, users can find it using the following query.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">client</span><span class="p">.</span><span class="nf">search</span><span class="p">({</span>
    <span class="na">index</span><span class="p">:</span> <span class="dl">'</span><span class="s1">albums</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">album</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">q</span><span class="p">:</span> <span class="dl">"</span><span class="s2">title:moons</span><span class="dl">"</span>
<span class="p">}).</span><span class="nf">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">resp</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">trace</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div> <p>Even though the exact word “<strong>moons</strong>” used in the query string does not appear in the album’s title (it reads “The Dark side of the <strong>moon</strong>”), since we have applied the same analyzer both to the ‘title’ property and the query string, the query matches an inverted index and returns Pink Floyd’s album successfully.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hits:{ total: 1, max_score: 0.25316024, hits: [ [Object] ] } }
</code></pre></div></div> <h3 id="conclusion">Conclusion</h3> <p>Hopefully, you’ve got some intuition about using advanced Elasticsearch methods with Node.js elasticsearch.js client. Elasticsearch.js is a very powerful tool that provides one-to-one mapping with Elasticsearch REST API which means it covers the vast majority of methods used in the native Elasticsearch. Broad coverage of low-level Elasticsearch features, support for load balancers, intelligent handling of node/connection failures and easy integration into modern browsers makes elasticsearch.js the best solution for your Node.js applications.</p> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/2018-12-22-distill.bib"></d-bibliography> <div id="giscus_thread" style="max-width: 930px; margin: 0 auto;"> <script>let giscusTheme=determineComputedTheme(),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"golkir/golkir.github.io","data-repo-id":"","data-category":"Comments","data-category-id":"","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Kirill A. Goltsman. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> </body> </html>